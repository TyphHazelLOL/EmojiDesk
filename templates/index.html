<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EmojiDesk ‚Äî –ö—É–ø–∏ —Å–≤–æ—é –∫–ª–µ—Ç–∫—É</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f6f6f6;
            margin: 0;
            padding: 20px;
        }
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        #gridContainer {
            overflow: auto;
            max-height: 700px;
            margin-top: 20px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #fff;
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(96, 16px);
            grid-auto-rows: 16px;
            gap: 1px;
            justify-content: center;
        }
        .cell {
            width: 16px;
            height: 16px;
            border: 1px solid #eaeaea;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s, border 0.2s;
            background-size: cover;
            background-position: center;
        }
        .cell:hover { background: #f0f0f0; }
        .cell.selected { background: #cce5ff !important; border: 2px solid #007bff !important; }
        .cell.sold { cursor: not-allowed; }
        .stats { display:flex; gap:12px; margin:18px 0; flex-wrap:wrap; justify-content:center; }
        .stat { background:#f8f9fa; padding:12px 16px; border-radius:10px; border-left:4px solid #007bff; min-width:120px; text-align:center; }
        .stat .num { font-weight:700; font-size:18px; color:#007bff; }
        .controls { padding:18px; background:#f8f9fa; border-radius:12px; border:2px solid #e9ecef; margin-bottom:20px; }
        select, button { padding:10px 12px; border-radius:8px; border:1px solid #ddd; font-size:15px; }
        .buy-button { background:#28a745; color:#fff; border:none; font-weight:700; min-width:220px; cursor:pointer; }
        .buy-button[disabled] { background:#6c757d; cursor:not-allowed; }
        .payment-info { background:#e7f3ff; padding:12px; border-radius:8px; border:2px solid #b3d9ff; text-align:left; }
        .modal { position:fixed; inset:0; background:rgba(0,0,0,.66); display:none; place-items:center; z-index:1200; }
        .modal .box { background:#fff; padding:18px; border-radius:12px; max-width:460px; width:92%; position:relative; }
        .close { position:absolute; right:12px; top:8px; background:none; border:none; font-size:20px; cursor:pointer; }
        footer { text-align:center; color:#666; margin-top:12px; font-size:13px; }
        .instructions { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>üéØ EmojiDesk ‚Äî –ö—É–ø–∏ —Å–≤–æ—é –∫–ª–µ—Ç–∫—É</h1>

        <div class="instructions">
            <p><strong>üí° –ö–∞–∫ –∫—É–ø–∏—Ç—å –∫–ª–µ—Ç–∫–∏:</strong></p>
            <p>1. –í—ã–±–µ—Ä–∏ —ç–º–æ–¥–∑–∏ –∏ –Ω–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –∏—Ö</p>
            <p>2. –ù–∞–∂–º–∏ "–û–ü–õ–ê–¢–ò–¢–¨" –∏ –æ—Ç–ø—Ä–∞–≤—å —Ç–æ—á–Ω—É—é —Å—É–º–º—É —á–µ—Ä–µ–∑ DonationAlerts</p>
            <p>3. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–≤–æ–∏ —ç–º–æ–¥–∑–∏ –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ –¥–æ—Å–∫–µ!</p>
        </div>

        <div class="stats" id="stats">
            <div class="stat"><div class="num" id="totalCells">9216</div>–í—Å–µ–≥–æ –∫–ª–µ—Ç–æ–∫</div>
            <div class="stat"><div class="num" id="soldCells">0</div>–ó–∞–Ω—è—Ç–æ</div>
            <div class="stat"><div class="num" id="freeCells">9216</div>–°–≤–æ–±–æ–¥–Ω–æ</div>
            <div class="stat"><div class="num" id="completionPercent">0%</div>–ó–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
        </div>

        <div class="controls">
            <label for="emojiSelector">–≠–º–æ–¥–∑–∏:</label>
            <select id="emojiSelector">
                <option value="smile">üòÄ –£–ª—ã–±–∫–∞</option>
                <option value="cool">üòé –ö—Ä—É—Ç–æ–π</option>
                <option value="clown">ü§° –ö–ª–æ—É–Ω</option>
                <option value="skull">üíÄ –ß–µ—Ä–µ–ø</option>
                <option value="heart">‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ</option>
                <option value="fire">üî• –û–≥–æ–Ω—å</option>
                <option value="rocket">üöÄ –†–∞–∫–µ—Ç–∞</option>
                <option value="rainbow">üåà –†–∞–¥—É–≥–∞</option>
                <option value="target">üéØ –ú–∏—à–µ–Ω—å</option>
                <option value="star">‚≠ê –ó–≤–µ–∑–¥–∞</option>
            </select>
            <span id="selectedInfo" style="margin-left:20px;">–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏—Ö!</span>
            <div style="margin-top:10px;">
                <button id="buyButton" class="buy-button" disabled>–í–´–ë–†–ê–¢–¨ –ö–õ–ï–¢–ö–ò</button>
            </div>
        </div>

        <div id="gridContainer">
            <div id="grid"></div>
        </div>

        <footer>–ö–∞–∂–¥–∞—è –∫–ª–µ—Ç–∫–∞ = 1 —Ä—É–±–ª—å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ DonationAlerts –∫–ª–µ—Ç–∫–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∑–∞ —Ç–æ–±–æ–π.</footer>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="box">
            <button class="close" id="closeModal">√ó</button>
            <h3>–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ DonationAlerts</h3>
            <div class="payment-info">
                <p><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏:</strong> <span id="paymentCellCount">0</span> —à—Ç</p>
                <p><strong>–≠–º–æ–¥–∑–∏:</strong> <span id="paymentEmoji">üòÄ</span></p>
                <p><strong>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É:</strong> <span id="paymentAmount">0</span> —Ä—É–±</p>
                <p><strong>–í —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∂–∏—Ç–µ:</strong> "<span id="paymentMessage">order_xxx</span>"</p>
                <p>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –¥–æ 1 –º–∏–Ω—É—Ç—ã).</p>
            </div>
            <a id="donateLink" href="#" target="_blank" class="buy-button" style="background:#ff5722; margin-top:10px; text-decoration:none; display:inline-block;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</a>
            <div id="paymentStatus" style="margin-top:10px; background:#fff3cd; padding:8px; border-radius:8px;">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const GRID_SIZE = 96;
        const TOTAL_CELLS = GRID_SIZE * GRID_SIZE;
        const PRICE_PER_CELL = 1;

        let selectedCells = [];
        let orderNumber = null;
        let socket = null;

        const grid = document.getElementById('grid');
        const buyButton = document.getElementById('buyButton');
        const selectedInfo = document.getElementById('selectedInfo');
        const paymentModal = document.getElementById('paymentModal');
        const paymentStatus = document.getElementById('paymentStatus');
        const paymentAmount = document.getElementById('paymentAmount');
        const paymentCellCount = document.getElementById('paymentCellCount');
        const paymentEmoji = document.getElementById('paymentEmoji');
        const paymentMessage = document.getElementById('paymentMessage');
        const donateLink = document.getElementById('donateLink');

        function getEmojiImage(emojiType) {
            const emojiMap = {
                'smile': '/static/images/smile.png',
                'cool': '/static/images/cool.png',
                'clown': '/static/images/clown.png',
                'skull': '/static/images/skull.png',
                'heart': '/static/images/heart.png',
                'fire': '/static/images/fire.png',
                'rocket': '/static/images/rocket.png',
                'rainbow': '/static/images/rainbow.png',
                'target': '/static/images/target.png',
                'star': '/static/images/star.png'
            };
            return emojiMap[emojiType] || '/static/images/smile.png';
        }

        function getEmojiDisplay(emojiType) {
            const displayMap = {
                'smile': 'üòÄ', 'cool': 'üòé', 'clown': 'ü§°', 'skull': 'üíÄ',
                'heart': '‚ù§Ô∏è', 'fire': 'üî•', 'rocket': 'üöÄ', 'rainbow': 'üåà',
                'target': 'üéØ', 'star': '‚≠ê'
            };
            return displayMap[emojiType] || 'üòÄ';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
        function renderEmptyGrid() {
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 16px)`;
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `cell-${x}-${y}`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', () => onCellClick(x, y));
                    grid.appendChild(cell);
                }
            }
        }

        function updateSelectionVisuals() {
            document.querySelectorAll('.cell.selected').forEach(el => el.classList.remove('selected'));
            selectedCells.forEach(cell => {
                const el = document.getElementById(`cell-${cell.x}-${cell.y}`);
                if (el && !el.classList.contains('sold')) el.classList.add('selected');
            });
        }

        function updateSelectionInfo() {
            const total = selectedCells.length;
            const price = total * PRICE_PER_CELL;
            if (total === 0) {
                selectedInfo.textContent = '–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏—Ö!';
                buyButton.disabled = true;
                buyButton.textContent = '–í–´–ë–†–ê–¢–¨ –ö–õ–ï–¢–ö–ò';
            } else {
                const emoji = getEmojiDisplay(selectedCells[0].emoji);
                selectedInfo.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${total} –∫–ª–µ—Ç–æ–∫ | –≠–º–æ–¥–∑–∏: ${emoji} | –ò—Ç–æ–≥–æ: ${price} —Ä—É–±`;
                buyButton.disabled = false;
                buyButton.textContent = `–û–ü–õ–ê–¢–ò–¢–¨ ${price} –†–£–ë`;
            }
        }

        function onCellClick(x, y) {
            const el = document.getElementById(`cell-${x}-${y}`);
            if (!el || el.classList.contains('sold')) return;
            const emoji = document.getElementById('emojiSelector').value;
            const foundIndex = selectedCells.findIndex(c => c.x === x && c.y === y);
            if (foundIndex === -1) selectedCells.push({ x, y, emoji });
            else selectedCells.splice(foundIndex, 1);
            updateSelectionInfo();
            updateSelectionVisuals();
        }

        document.getElementById('emojiSelector').addEventListener('change', () => {
            const newEmoji = document.getElementById('emojiSelector').value;
            selectedCells = selectedCells.map(cell => ({ ...cell, emoji: newEmoji }));
            updateSelectionInfo();
            updateSelectionVisuals();
        });

        buyButton.addEventListener('click', async () => {
            if (selectedCells.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–µ—Ç–∫–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
            try {
                const response = await fetch('/api/buy_cells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cells: selectedCells })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
                orderNumber = data.order_number;
                paymentAmount.textContent = Number(data.amount).toFixed(2);
                paymentCellCount.textContent = data.cell_count;
                paymentEmoji.textContent = getEmojiDisplay(selectedCells[0].emoji);
                paymentMessage.textContent = data.payment_message;
                donateLink.href = 'https://www.donationalerts.com/r/your_channel';
                paymentModal.style.display = 'grid';
                paymentStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...';
                pollPaymentStatus(orderNumber);
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
        let pollInterval = null;
        function pollPaymentStatus(order) {
            if (pollInterval) clearInterval(pollInterval);
            let attempts = 0;
            pollInterval = setInterval(async () => {
                attempts++;
                try {
                    const response = await fetch(`/api/check_payment/${order}`);
                    const data = await response.json();
                    if (data.status === 'confirmed') {
                        clearInterval(pollInterval);
                        paymentStatus.textContent = '‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –≠–º–æ–¥–∑–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
                        paymentStatus.style.background = '#d4edda';
                        selectedCells.forEach(cell => {
                            const el = document.getElementById(`cell-${cell.x}-${cell.y}`);
                            if (el) {
                                el.classList.add('sold');
                                el.classList.remove('selected');
                                el.style.backgroundImage = `url('${getEmojiImage(cell.emoji)}')`;
                            }
                        });
                        updateStats(selectedCells.length);
                        selectedCells = [];
                        updateSelectionInfo();
                        setTimeout(() => { paymentModal.style.display = 'none'; }, 1500);
                    } else if (data.status === 'partial') {
                        paymentStatus.textContent = `‚ùó –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë ${data.remaining} —Ä—É–± ‚Äî —Ç–æ–≥–¥–∞ —ç–º–æ–¥–∑–∏ –ø–æ—è–≤—è—Ç—Å—è.`;
                        paymentStatus.style.background = '#fff3cd';
                    } else if (data.status === 'pending') {
                        paymentStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...';
                        paymentStatus.style.background = '';
                    }
                } catch (err) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞', err);
                }
                if (attempts > 60) {
                    clearInterval(pollInterval);
                    paymentStatus.textContent = '‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                    paymentStatus.style.background = '#fff3cd';
                }
            }, 5000);
        }

        function updateStats(added = 0) {
            const soldEl = document.getElementById('soldCells');
            const freeEl = document.getElementById('freeCells');
            const percentEl = document.getElementById('completionPercent');

            const soldNow = parseInt(soldEl.textContent || '0', 10) + added;
            soldEl.textContent = soldNow;
            freeEl.textContent = TOTAL_CELLS - soldNow;

            // ‚úÖ –ø—Ä–æ—Ü–µ–Ω—Ç —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
            const percent = ((soldNow / TOTAL_CELLS) * 100).toFixed(2);
            percentEl.textContent = percent + '%';
        }


        // WebSocket
        function connectWebSocket() {
            socket = io();
            socket.on('connect', () => console.log('Connected'));
            socket.on('pixel_update', (data) => {
                const el = document.getElementById(`cell-${data.x}-${data.y}`);
                if (el && !el.classList.contains('sold')) {
                    el.classList.add('sold');
                    el.style.backgroundImage = `url('${getEmojiImage(data.emoji)}')`;
                    updateStats(1);
                }
            });
            socket.on('disconnect', () => console.log('Disconnected'));
        }

        async function loadExistingPixels() {
            try {
                const response = await fetch('/api/pixels');
                const pixels = await response.json();

                // –û—Ç–º–µ—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ –∫–ª–µ—Ç–∫–∏
                pixels.forEach(pixel => {
                    const el = document.getElementById(`cell-${pixel.x}-${pixel.y}`);
                    if (el && pixel.emoji) {
                        el.classList.add('sold');
                        el.style.backgroundImage = `url('${getEmojiImage(pixel.emoji)}')`;
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const soldCount = pixels.length;
                const freeCount = TOTAL_CELLS - soldCount;
                const percent = ((soldCount / TOTAL_CELLS) * 100).toFixed(2);

                document.getElementById('soldCells').textContent = soldCount;
                document.getElementById('freeCells').textContent = freeCount;
                document.getElementById('completionPercent').textContent = percent + '%';

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∏–∫—Å–µ–ª–µ–π:', err);
            }
        }


        async function init() {
            renderEmptyGrid();
            await loadExistingPixels();
            connectWebSocket();
        }

        init();
    </script>
</body>
</html>
