<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EmojiDesk ‚Äî –ö—É–ø–∏ —Å–≤–æ—é –∫–ª–µ—Ç–∫—É</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f6f6f6;
            margin: 0;
            padding: 20px;
        }
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        #gridContainer {
            overflow: auto;
            max-height: 700px;
            margin-top: 20px;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #fff;
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(96, 16px);
            grid-auto-rows: 16px;
            gap: 1px;
            justify-content: center;
        }
        .cell {
            width: 16px;
            height: 16px;
            border: 1px solid #eaeaea;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s, border 0.2s;
            background-size: cover;
            background-position: center;
        }
        .cell:hover { background: #f0f0f0; }
        .cell.selected { background: #cce5ff !important; border: 2px solid #007bff !important; }
        .cell.sold { cursor: not-allowed; }
        .stats { display:flex; gap:12px; margin:18px 0; flex-wrap:wrap; justify-content:center; }
        .stat { background:#f8f9fa; padding:12px 16px; border-radius:10px; border-left:4px solid #007bff; min-width:120px; text-align:center; }
        .stat .num { font-weight:700; font-size:18px; color:#007bff; }
        .controls { padding:18px; background:#f8f9fa; border-radius:12px; border:2px solid #e9ecef; margin-bottom:20px; }
        select, button, input { padding:10px 12px; border-radius:8px; border:1px solid #ddd; font-size:15px; margin:5px; }
        .buy-button { background:#28a745; color:#fff; border:none; font-weight:700; min-width:220px; cursor:pointer; }
        .buy-button[disabled] { background:#6c757d; cursor:not-allowed; }
        .promo-button { background:#ff6b35; color:#fff; border:none; font-weight:700; cursor:pointer; }
        .free-button { background:#9c27b0; color:#fff; border:none; font-weight:700; cursor:pointer; }
        .payment-info { background:#e7f3ff; padding:12px; border-radius:8px; border:2px solid #b3d9ff; text-align:left; }
        .promo-info { background:#d4edda; padding:12px; border-radius:8px; border:2px solid #28a745; margin:10px 0; }
        .modal { position:fixed; inset:0; background:rgba(0,0,0,.66); display:none; place-items:center; z-index:1200; }
        .modal .box { background:#fff; padding:18px; border-radius:12px; max-width:460px; width:92%; position:relative; }
        .close { position:absolute; right:12px; top:8px; background:none; border:none; font-size:20px; cursor:pointer; }
        footer { text-align:center; color:#666; margin-top:12px; font-size:13px; }
        .instructions { background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>üéØ EmojiDesk ‚Äî –ö—É–ø–∏ —Å–≤–æ—é –∫–ª–µ—Ç–∫—É</h1>

        <div class="instructions">
            <p><strong>üí° –ö–∞–∫ –∫—É–ø–∏—Ç—å –∫–ª–µ—Ç–∫–∏:</strong></p>
            <p>1. –í—ã–±–µ—Ä–∏ —ç–º–æ–¥–∑–∏ –∏ –Ω–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å –∏—Ö</p>
            <p>2. –ù–∞–∂–º–∏ "–û–ü–õ–ê–¢–ò–¢–¨" –∏ –æ—Ç–ø—Ä–∞–≤—å —Ç–æ—á–Ω—É—é —Å—É–º–º—É —á–µ—Ä–µ–∑ DonationAlerts</p>
            <p>3. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Ç–≤–æ–∏ —ç–º–æ–¥–∑–∏ –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ –¥–æ—Å–∫–µ!</p>
            <p><strong>üéÅ –ï—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥? –í–≤–µ–¥–∏ –µ–≥–æ –Ω–∏–∂–µ!</strong></p>
        </div>

        <div class="stats" id="stats">
            <div class="stat"><div class="num" id="totalCells">9216</div>–í—Å–µ–≥–æ –∫–ª–µ—Ç–æ–∫</div>
            <div class="stat"><div class="num" id="soldCells">0</div>–ó–∞–Ω—è—Ç–æ</div>
            <div class="stat"><div class="num" id="freeCells">9216</div>–°–≤–æ–±–æ–¥–Ω–æ</div>
            <div class="stat"><div class="num" id="completionPercent">0%</div>–ó–∞–ø–æ–ª–Ω–µ–Ω–æ</div>
        </div>

        <div class="controls">
            <label for="emojiSelector">–≠–º–æ–¥–∑–∏:</label>
            <select id="emojiSelector">
                <option value="smile">üòÄ –£–ª—ã–±–∫–∞</option>
                <option value="cool">üòé –ö—Ä—É—Ç–æ–π</option>
                <option value="clown">ü§° –ö–ª–æ—É–Ω</option>
                <option value="skull">üíÄ –ß–µ—Ä–µ–ø</option>
                <option value="heart">‚ù§Ô∏è –°–µ—Ä–¥—Ü–µ</option>
                <option value="fire">üî• –û–≥–æ–Ω—å</option>
                <option value="rocket">üöÄ –†–∞–∫–µ—Ç–∞</option>
                <option value="rainbow">üåà –†–∞–¥—É–≥–∞</option>
                <option value="target">üéØ –ú–∏—à–µ–Ω—å</option>
                <option value="star">‚≠ê –ó–≤–µ–∑–¥–∞</option>
            </select>
            <br>
            <input type="text" id="promocodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" style="width: 200px;">
            <button id="applyPromoButton" class="promo-button">–ü–†–ò–ú–ï–ù–ò–¢–¨ –ü–†–û–ú–û–ö–û–î</button>
            <span id="promoStatus"></span>
            <br>
            <span id="selectedInfo" style="margin-left:20px;">–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏—Ö!</span>
            <div style="margin-top:10px;">
                <button id="buyButton" class="buy-button" disabled>–í–´–ë–†–ê–¢–¨ –ö–õ–ï–¢–ö–ò</button>
            </div>
        </div>

        <div id="gridContainer">
            <div id="grid"></div>
        </div>

        <footer>–ö–∞–∂–¥–∞—è –∫–ª–µ—Ç–∫–∞ = 1 —Ä—É–±–ª—å. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ DonationAlerts –∫–ª–µ—Ç–∫–∞ –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è –∑–∞ —Ç–æ–±–æ–π.</footer>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="box">
            <button class="close" id="closeModal">√ó</button>
            <h3 id="modalTitle">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ DonationAlerts</h3>
            <div class="payment-info">
                <p><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–ª–µ—Ç–∫–∏:</strong> <span id="paymentCellCount">0</span> —à—Ç</p>
                <p><strong>–≠–º–æ–¥–∑–∏:</strong> <span id="paymentEmoji">üòÄ</span></p>
                <p id="amountLine"><strong>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É:</strong> <span id="paymentAmount">0</span> —Ä—É–±</p>
                <p id="messageLine"><strong>–í —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–∫–∞–∂–∏—Ç–µ:</strong> "<span id="paymentMessage">order_xxx</span>"</p>
                <div id="promoAppliedInfo" class="promo-info" style="display:none;">
                    <strong>üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!</strong> –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <span id="promoDiscountCells">18</span> –∫–ª–µ—Ç–æ–∫ <strong>–ë–ï–°–ü–õ–ê–¢–ù–û</strong>!
                    <br>–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ" –Ω–∏–∂–µ.
                </div>
                <p id="waitingText">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –¥–æ 1 –º–∏–Ω—É—Ç—ã).</p>
            </div>
            <a id="donateLink" href="" target="_blank" class="buy-button" style="background:#ff5722; margin-top:10px; text-decoration:none; display:inline-block;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ</a>
            <button id="freeActivateButton" class="free-button" style="display:none; margin-top:10px; width:100%;">üéÅ –ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –ë–ï–°–ü–õ–ê–¢–ù–û</button>
            <div id="paymentStatus" style="margin-top:10px; background:#fff3cd; padding:8px; border-radius:8px;">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const GRID_SIZE = 96;
        const TOTAL_CELLS = GRID_SIZE * GRID_SIZE;
        const PRICE_PER_CELL = 1;

        let selectedCells = [];
        let orderNumber = null;
        let socket = null;
        let activePromocode = null;

        const grid = document.getElementById('grid');
        const buyButton = document.getElementById('buyButton');
        const selectedInfo = document.getElementById('selectedInfo');
        const paymentModal = document.getElementById('paymentModal');
        const paymentStatus = document.getElementById('paymentStatus');
        const paymentAmount = document.getElementById('paymentAmount');
        const paymentCellCount = document.getElementById('paymentCellCount');
        const paymentEmoji = document.getElementById('paymentEmoji');
        const paymentMessage = document.getElementById('paymentMessage');
        const donateLink = document.getElementById('donateLink');
        const promocodeInput = document.getElementById('promocodeInput');
        const applyPromoButton = document.getElementById('applyPromoButton');
        const promoStatus = document.getElementById('promoStatus');
        const promoAppliedInfo = document.getElementById('promoAppliedInfo');
        const promoDiscountCells = document.getElementById('promoDiscountCells');
        const freeActivateButton = document.getElementById('freeActivateButton');
        const modalTitle = document.getElementById('modalTitle');
        const amountLine = document.getElementById('amountLine');
        const messageLine = document.getElementById('messageLine');
        const waitingText = document.getElementById('waitingText');

        function getEmojiImage(emojiType) {
            const emojiMap = {
                'smile': '/static/images/smile.png',
                'cool': '/static/images/cool.png',
                'clown': '/static/images/clown.png',
                'skull': '/static/images/skull.png',
                'heart': '/static/images/heart.png',
                'fire': '/static/images/fire.png',
                'rocket': '/static/images/rocket.png',
                'rainbow': '/static/images/rainbow.png',
                'target': '/static/images/target.png',
                'star': '/static/images/star.png'
            };
            return emojiMap[emojiType] || '/static/images/smile.png';
        }

        function getEmojiDisplay(emojiType) {
            const displayMap = {
                'smile': 'üòÄ', 'cool': 'üòé', 'clown': 'ü§°', 'skull': 'üíÄ',
                'heart': '‚ù§Ô∏è', 'fire': 'üî•', 'rocket': 'üöÄ', 'rainbow': 'üåà',
                'target': 'üéØ', 'star': '‚≠ê'
            };
            return displayMap[emojiType] || 'üòÄ';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
        function renderEmptyGrid() {
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 16px)`;
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `cell-${x}-${y}`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', () => onCellClick(x, y));
                    grid.appendChild(cell);
                }
            }
        }

        function updateSelectionVisuals() {
            document.querySelectorAll('.cell.selected').forEach(el => el.classList.remove('selected'));
            selectedCells.forEach(cell => {
                const el = document.getElementById(`cell-${cell.x}-${cell.y}`);
                if (el && !el.classList.contains('sold')) el.classList.add('selected');
            });
        }

        function updateSelectionInfo() {
            const total = selectedCells.length;
            
            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–µ—Ç–æ–∫
            if (activePromocode) {
                const requiredCells = activePromocode.discount_cells;
                if (total !== requiredCells) {
                    selectedInfo.textContent = `–î–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ ${requiredCells} –∫–ª–µ—Ç–æ–∫`;
                    buyButton.disabled = true;
                    buyButton.textContent = `–ù–£–ñ–ù–û ${requiredCells} –ö–õ–ï–¢–û–ö`;
                    return;
                }
                // üéâ –ë–ï–°–ü–õ–ê–¢–ù–û!
                selectedInfo.textContent = `üéÅ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! ${total} –∫–ª–µ—Ç–æ–∫ –ë–ï–°–ü–õ–ê–¢–ù–û!`;
                buyButton.textContent = `–ü–û–õ–£–ß–ò–¢–¨ –ë–ï–°–ü–õ–ê–¢–ù–û`;
                buyButton.disabled = false;
            } else {
                // –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
                const price = total * PRICE_PER_CELL;
                if (total === 0) {
                    selectedInfo.textContent = '–ù–∞–∂–∏–º–∞–π –Ω–∞ –∫–ª–µ—Ç–∫–∏ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∏—Ö!';
                    buyButton.disabled = true;
                    buyButton.textContent = '–í–´–ë–†–ê–¢–¨ –ö–õ–ï–¢–ö–ò';
                } else {
                    const emoji = getEmojiDisplay(selectedCells[0].emoji);
                    selectedInfo.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${total} –∫–ª–µ—Ç–æ–∫ | –≠–º–æ–¥–∑–∏: ${emoji} | –ò—Ç–æ–≥–æ: ${price} —Ä—É–±`;
                    buyButton.textContent = `–û–ü–õ–ê–¢–ò–¢–¨ ${price} –†–£–ë`;
                    buyButton.disabled = false;
                }
            }
        }

        function onCellClick(x, y) {
            const el = document.getElementById(`cell-${x}-${y}`);
            if (!el || el.classList.contains('sold')) return;
            const emoji = document.getElementById('emojiSelector').value;
            
            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–±–æ—Ä
            if (activePromocode) {
                const maxCells = activePromocode.discount_cells;
                const foundIndex = selectedCells.findIndex(c => c.x === x && c.y === y);
                
                if (foundIndex === -1) {
                    if (selectedCells.length >= maxCells) {
                        alert(`–ü—Ä–æ–º–æ–∫–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ ${maxCells} –∫–ª–µ—Ç–æ–∫`);
                        return;
                    }
                    selectedCells.push({ x, y, emoji });
                } else {
                    selectedCells.splice(foundIndex, 1);
                }
            } else {
                // –û–±—ã—á–Ω—ã–π –≤—ã–±–æ—Ä –±–µ–∑ –ø—Ä–æ–º–æ–∫–æ–¥–∞
                const foundIndex = selectedCells.findIndex(c => c.x === x && c.y === y);
                if (foundIndex === -1) selectedCells.push({ x, y, emoji });
                else selectedCells.splice(foundIndex, 1);
            }
            
            updateSelectionInfo();
            updateSelectionVisuals();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
        applyPromoButton.addEventListener('click', async () => {
            const code = promocodeInput.value.trim();
            if (!code) {
                promoStatus.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';
                promoStatus.style.color = 'red';
                return;
            }

            try {
                const response = await fetch(`/api/check_promocode/${code}`);
                const data = await response.json();
                
                if (data.valid) {
                    activePromocode = data;
                    promoStatus.textContent = `‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! ${data.discount_cells} –∫–ª–µ—Ç–æ–∫ –ë–ï–°–ü–õ–ê–¢–ù–û!`;
                    promoStatus.style.color = 'green';
                    promocodeInput.disabled = true;
                    applyPromoButton.disabled = true;
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
                    if (selectedCells.length !== data.discount_cells) {
                        selectedCells = [];
                        updateSelectionVisuals();
                    }
                    updateSelectionInfo();
                } else {
                    promoStatus.textContent = `‚ùå ${data.error}`;
                    promoStatus.style.color = 'red';
                    activePromocode = null;
                }
            } catch (error) {
                promoStatus.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞';
                promoStatus.style.color = 'red';
            }
        });

        buyButton.addEventListener('click', async () => {
            if (selectedCells.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–µ—Ç–∫–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
            if (activePromocode && selectedCells.length !== activePromocode.discount_cells) {
                alert(`–î–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ ${activePromocode.discount_cells} –∫–ª–µ—Ç–æ–∫`);
                return;
            }

            try {
                const response = await fetch('/api/buy_cells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        cells: selectedCells,
                        promocode: activePromocode ? activePromocode.code : ''
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
                
                orderNumber = data.order_number;
                paymentAmount.textContent = Number(data.amount).toFixed(2);
                paymentCellCount.textContent = data.cell_count;
                paymentEmoji.textContent = getEmojiDisplay(selectedCells[0].emoji);
                paymentMessage.textContent = data.payment_message;
                donateLink.href = 'https://www.donationalerts.com/r/EmojiAdd';
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
                if (data.promocode_used) {
                    // üéâ –ë–ï–°–ü–õ–ê–¢–ù–´–ô —Ä–µ–∂–∏–º
                    modalTitle.textContent = 'üéÅ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞';
                    promoAppliedInfo.style.display = 'block';
                    promoDiscountCells.textContent = data.promocode_discount;
                    amountLine.style.display = 'none';
                    messageLine.style.display = 'none';
                    donateLink.style.display = 'none';
                    freeActivateButton.style.display = 'block';
                    waitingText.textContent = '–ù–∞–∂–º–∏—Ç–µ "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ" —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç—å –∫–ª–µ—Ç–∫–∏.';
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    freeActivateButton.onclick = () => {
                        activateFreeOrder(orderNumber);
                    };
                } else {
                    // –û–±—ã—á–Ω—ã–π –ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º
                    modalTitle.textContent = '–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ DonationAlerts';
                    promoAppliedInfo.style.display = 'none';
                    amountLine.style.display = 'block';
                    messageLine.style.display = 'block';
                    donateLink.style.display = 'inline-block';
                    freeActivateButton.style.display = 'none';
                    waitingText.textContent = '–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –¥–æ 1 –º–∏–Ω—É—Ç—ã).';
                }
                
                paymentModal.style.display = 'grid';
                paymentStatus.textContent = data.promocode_used ? '‚è≥ –ì–æ—Ç–æ–≤–æ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏...' : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...';
                
                if (!data.promocode_used) {
                    pollPaymentStatus(orderNumber);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        });

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
        function activateFreeOrder(orderId) {
            freeActivateButton.disabled = true;
            freeActivateButton.textContent = 'üéÅ –ê–ö–¢–ò–í–ò–†–£–ï–¢–°–Ø...';
            paymentStatus.textContent = '‚è≥ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–ª–µ—Ç–∫–∏...';
            
            setTimeout(() => {
                paymentStatus.textContent = '‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!';
                paymentStatus.style.background = '#d4edda';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                selectedCells.forEach(cell => {
                    const el = document.getElementById(`cell-${cell.x}-${cell.y}`);
                    if (el) {
                        el.classList.add('sold');
                        el.classList.remove('selected');
                        el.style.backgroundImage = `url('${getEmojiImage(cell.emoji)}')`;
                    }
                });
                
                updateStats(selectedCells.length);
                selectedCells = [];
                updateSelectionInfo();
                
                setTimeout(() => { 
                    paymentModal.style.display = 'none';
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                    if (activePromocode) {
                        activePromocode = null;
                        promocodeInput.value = '';
                        promocodeInput.disabled = false;
                        applyPromoButton.disabled = false;
                        promoStatus.textContent = '';
                    }
                }, 1500);
            }, 1000);
        }

        document.getElementById('closeModal').addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤)
        let pollInterval = null;
        function pollPaymentStatus(order) {
            if (pollInterval) clearInterval(pollInterval);
            let attempts = 0;
            pollInterval = setInterval(async () => {
                attempts++;
                try {
                    const response = await fetch(`/api/check_payment/${order}`);
                    const data = await response.json();
                    if (data.status === 'confirmed') {
                        clearInterval(pollInterval);
                        paymentStatus.textContent = '‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –≠–º–æ–¥–∑–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã.';
                        paymentStatus.style.background = '#d4edda';
                        selectedCells.forEach(cell => {
                            const el = document.getElementById(`cell-${cell.x}-${cell.y}`);
                            if (el) {
                                el.classList.add('sold');
                                el.classList.remove('selected');
                                el.style.backgroundImage = `url('${getEmojiImage(cell.emoji)}')`;
                            }
                        });
                        updateStats(selectedCells.length);
                        selectedCells = [];
                        updateSelectionInfo();
                        setTimeout(() => { 
                            paymentModal.style.display = 'none';
                        }, 1500);
                    } else if (data.status === 'rejected') {
                        paymentStatus.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω.';
                        paymentStatus.style.background = '#f8d7da';
                    } else if (data.status === 'pending') {
                        paymentStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã...';
                        paymentStatus.style.background = '';
                    }
                } catch (err) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞', err);
                }
                if (attempts > 60) {
                    clearInterval(pollInterval);
                    paymentStatus.textContent = '‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                    paymentStatus.style.background = '#fff3cd';
                }
            }, 5000);
        }

        function updateStats(added = 0) {
            const soldEl = document.getElementById('soldCells');
            const freeEl = document.getElementById('freeCells');
            const percentEl = document.getElementById('completionPercent');

            const soldNow = parseInt(soldEl.textContent || '0', 10) + added;
            soldEl.textContent = soldNow;
            freeEl.textContent = TOTAL_CELLS - soldNow;

            const percent = ((soldNow / TOTAL_CELLS) * 100).toFixed(2);
            percentEl.textContent = percent + '%';
        }

        // WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function connectWebSocket() {
            socket = io();
            socket.on('connect', () => {
                console.log('Connected to WebSocket');
                // –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                loadExistingPixels();
            });
            
            socket.on('pixel_update', (data) => {
                console.log('Pixel update received:', data);
                const el = document.getElementById(`cell-${data.x}-${data.y}`);
                if (el && !el.classList.contains('sold')) {
                    el.classList.add('sold');
                    el.style.backgroundImage = `url('${getEmojiImage(data.emoji)}')`;
                    updateStats(1);
                }
            });
            
            socket.on('disconnect', () => console.log('Disconnected from WebSocket'));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∏–∫—Å–µ–ª–µ–π
        async function loadExistingPixels() {
            try {
                console.log('Loading existing pixels...');
                const response = await fetch('/api/pixels');
                if (!response.ok) throw new Error('Failed to fetch pixels');
                
                const pixels = await response.json();
                console.log(`Loaded ${pixels.length} pixels`);

                let soldCount = 0;
                
                pixels.forEach(pixel => {
                    const el = document.getElementById(`cell-${pixel.x}-${pixel.y}`);
                    if (el) {
                        if (!el.classList.contains('sold')) {
                            el.classList.add('sold');
                            el.style.backgroundImage = `url('${getEmojiImage(pixel.emoji)}')`;
                            soldCount++;
                        }
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const freeCount = TOTAL_CELLS - soldCount;
                const percent = ((soldCount / TOTAL_CELLS) * 100).toFixed(2);

                document.getElementById('soldCells').textContent = soldCount;
                document.getElementById('freeCells').textContent = freeCount;
                document.getElementById('completionPercent').textContent = percent + '%';

                console.log(`Stats updated: ${soldCount} sold, ${freeCount} free, ${percent}%`);

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∏–∫—Å–µ–ª–µ–π:', err);
                setTimeout(loadExistingPixels, 3000);
            }
        }

        async function init() {
            console.log('Initializing application...');
            
            // –°–Ω–∞—á–∞–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∏–º –ø—É—Å—Ç—É—é —Å–µ—Ç–∫—É
            renderEmptyGrid();
            console.log('Grid rendered');
            
            // –ó–∞—Ç–µ–º –ø–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
            connectWebSocket();
            console.log('WebSocket connecting...');
            
            console.log('Initialization complete');
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–≥–¥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
